{% extends 'base.html' %}

{% block title %}Operator Settings{% endblock %}

{% block content %}
<div class="container">
    <div class="row">
        <div class="col-12">
            <h1 class="mb-4">
                <i class="fas fa-cog me-2"></i>Operator Settings
            </h1>
        </div>
    </div>

    <div class="row">
        <!-- Account Settings -->
        <div class="col-md-6 mb-4">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-user-cog me-2"></i>Account Settings
                    </h5>
                </div>
                <div class="card-body">
                    <form id="profileForm">
                        <div class="mb-3">
                            <label for="username" class="form-label">Username</label>
                            <input type="text" class="form-control" id="username" value="{{ current_user.username }}" readonly>
                            <small class="text-muted">Username cannot be changed</small>
                        </div>
                        <div class="mb-3">
                            <label for="email" class="form-label">Email Address</label>
                            <input type="email" class="form-control" id="email" value="{{ current_user.email }}" required>
                        </div>
                        <div class="mb-3">
                            <label for="companyName" class="form-label">Company Name</label>
                            <input type="text" class="form-control" id="companyName" value="{{ current_user.company_name or '' }}">
                        </div>
                        <div class="mb-3">
                            <label for="contactNumber" class="form-label">Contact Number</label>
                            <input type="tel" class="form-control" id="contactNumber" value="{{ current_user.contact_number or '' }}">
                        </div>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-2"></i>Update Profile
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Password Change -->
        <div class="col-md-6 mb-4">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0">
                        <i class="fas fa-key me-2"></i>Change Password
                    </h5>
                </div>
                <div class="card-body">
                    <form id="passwordForm">
                        <div class="mb-3">
                            <label for="currentPassword" class="form-label">Current Password</label>
                            <input type="password" class="form-control" id="currentPassword" required>
                        </div>
                        <div class="mb-3">
                            <label for="newPassword" class="form-label">New Password</label>
                            <input type="password" class="form-control" id="newPassword" required>
                        </div>
                        <div class="mb-3">
                            <label for="confirmPassword" class="form-label">Confirm New Password</label>
                            <input type="password" class="form-control" id="confirmPassword" required>
                        </div>
                        <button type="submit" class="btn btn-warning">
                            <i class="fas fa-key me-2"></i>Change Password
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    

    <div class="row">
        <!-- Account Actions (kept) -->
        <div class="col-md-6 mb-4">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-danger text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-exclamation-triangle me-2"></i>Account Actions
                    </h5>
                </div>
                <div class="card-body">
                    <p class="text-muted">Important actions for your account.</p>
                    <div class="d-grid gap-2">
                        <button type="button" class="btn btn-outline-warning" onclick="exportAccountData()">
                            <i class="fas fa-download me-2"></i>Export Account Data
                        </button>
                        <a class="btn btn-outline-info" href="{{ url_for('operator.operator_action_logs') }}">
                            <i class="fas fa-history me-2"></i>View Activity Log
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Confirmation Modal -->
<div class="modal fade" id="confirmationModal" tabindex="-1" aria-labelledby="confirmationModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="confirmationModalLabel">Confirm Action</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="confirmationMessage">
                Are you sure you want to proceed with this action?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirmActionBtn">Confirm</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Profile form submission
        document.getElementById('profileForm').addEventListener('submit', function(e) {
            e.preventDefault();
            updateProfile();
        });

        // Password form submission
        document.getElementById('passwordForm').addEventListener('submit', function(e) {
            e.preventDefault();
            changePassword();
        });

        // Load saved settings
        loadSavedSettings();
    });

    async function updateProfile() {
        const email = document.getElementById('email').value;
        const companyName = document.getElementById('companyName').value;
        const contactNumber = document.getElementById('contactNumber').value;
        
        try {
            const response = await fetch('/operator/profile/update', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ 
                    email: email,
                    company_name: companyName,
                    contact_number: contactNumber
                })
            });
            
            const data = await response.json();
            
            if (response.ok) {
                showToast('Success', data.message, 'success');
            } else {
                showToast('Error', data.error || 'Failed to update profile.', 'error');
            }
        } catch (error) {
            console.error('Error updating profile:', error);
            showToast('Error', 'An error occurred while updating profile.', 'error');
        }
    }

    async function changePassword() {
        const currentPassword = document.getElementById('currentPassword').value;
        const newPassword = document.getElementById('newPassword').value;
        const confirmPassword = document.getElementById('confirmPassword').value;
        
        if (newPassword !== confirmPassword) {
            showToast('Error', 'New password and confirmation do not match.', 'error');
            return;
        }
        
        try {
            const response = await fetch('/operator/password', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    current_password: currentPassword,
                    new_password: newPassword,
                    confirm_password: confirmPassword
                })
            });
            
            const data = await response.json();
            
            if (response.ok) {
                showToast('Success', data.message, 'success');
                document.getElementById('passwordForm').reset();
            } else {
                showToast('Error', data.error || 'Failed to change password.', 'error');
            }
        } catch (error) {
            console.error('Error changing password:', error);
            showToast('Error', 'An error occurred while changing password.', 'error');
        }
    }

    function showHelp() {
        showToast('Info', 'User manual feature coming soon!', 'info');
    }

    function contactSupport() {
        showToast('Info', 'Contact support feature coming soon!', 'info');
    }

    function showFaq() {
        showToast('Info', 'FAQ feature coming soon!', 'info');
    }

    function refreshStatus() {
        const now = new Date();
        document.getElementById('lastUpdateTime').textContent = now.toLocaleString();
        showToast('Success', 'Status refreshed successfully!', 'success');
    }

    function exportAccountData() {
        // Trigger download of JSON export
        window.location.href = "{{ url_for('operator.export_operator_account') }}";
    }

    function refreshSession() {
        showToast('Info', 'Session refresh feature coming soon!', 'info');
    }

    function loadSavedSettings() {
        // Initialize last update time
        const now = new Date();
        document.getElementById('lastUpdateTime').textContent = now.toLocaleString();
    }

    function showConfirmationModal(title, message, onConfirm) {
        document.getElementById('confirmationModalLabel').textContent = title;
        document.getElementById('confirmationMessage').textContent = message;
        
        document.getElementById('confirmActionBtn').onclick = function() {
            onConfirm();
            const modal = bootstrap.Modal.getInstance(document.getElementById('confirmationModal'));
            modal.hide();
        };
        
        const modal = new bootstrap.Modal(document.getElementById('confirmationModal'));
        modal.show();
    }

    function showToast(title, message, type = 'info') {
        // Create toast container if it doesn't exist
        let toastContainer = document.querySelector('.toast-container');
        if (!toastContainer) {
            toastContainer = document.createElement('div');
            toastContainer.className = 'toast-container position-fixed bottom-0 end-0 p-3';
            document.body.appendChild(toastContainer);
        }
        
        // Create toast element
        const toastEl = document.createElement('div');
        toastEl.className = `toast align-items-center text-white bg-${type === 'info' ? 'primary' : type === 'error' ? 'danger' : type}`;
        toastEl.setAttribute('role', 'alert');
        toastEl.setAttribute('aria-live', 'assertive');
        toastEl.setAttribute('aria-atomic', 'true');
        
        toastEl.innerHTML = `
            <div class="d-flex">
                <div class="toast-body">
                    <strong>${title}</strong>: ${message}
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        `;
        
        // Add to container
        toastContainer.appendChild(toastEl);
        
        // Initialize and show toast
        const toast = new bootstrap.Toast(toastEl, {
            autohide: true,
            delay: 5000
        });
        toast.show();
    }
</script>
{% endblock %}
