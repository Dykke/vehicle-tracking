{% extends 'base.html' %}

{% block title %}Manage Drivers{% endblock %}

{% block head %}
<!-- Mobile viewport optimization -->
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

<style>
    /* Toast animation */
    @keyframes slideIn {
        from {
            transform: translateX(400px);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }
    
    /* MOBILE-FIRST RESPONSIVE DESIGN FOR MANAGE DRIVERS */
    
    /* Base mobile styles */
    .page-header {
        flex-direction: column;
        align-items: stretch !important;
        gap: 1rem;
    }
    
    .page-header h2 {
        font-size: 1.5rem;
        text-align: center;
        margin-bottom: 0;
    }
    
    .page-header .btn {
        width: 100%;
        padding: 0.75rem;
        font-size: 1rem;
    }
    
    /* Mobile-optimized grid system */
    @media (max-width: 767.98px) {
        .col-md-6, .col-lg-4 {
            margin-bottom: 1.5rem;
        }
        
        .card-body {
            padding: 1rem;
        }
        
        .modal-dialog {
            margin: 0.5rem;
            max-width: calc(100% - 1rem);
        }
        
        .modal-body {
            padding: 1rem;
        }
        
        .modal-footer {
            padding: 0.75rem 1rem;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .modal-footer .btn {
            width: 100%;
            margin: 0 !important;
        }
        
        /* Stack form elements vertically on mobile */
        .form-group {
            margin-bottom: 1rem;
        }
        
        /* Optimize button sizes for touch */
        .btn {
            min-height: 44px;
            font-size: 1rem;
        }
        
        /* Improve table responsiveness */
        .table-responsive {
            font-size: 0.875rem;
        }
        
        /* Optimize card spacing */
        .card {
            margin-bottom: 1rem;
        }
        
        .card-header h5 {
            font-size: 1.1rem;
        }
        
        /* Improve driver list display on mobile */
        .driver-item {
            padding: 1rem;
            margin-bottom: 1rem;
        }
        
        .driver-item .d-flex {
            flex-direction: column;
            gap: 0.75rem;
        }
        
        .driver-item .btn-group {
            flex-direction: column;
            width: 100%;
        }
        
        .driver-item .btn {
            width: 100%;
            margin-bottom: 0.5rem;
            border-radius: 0.375rem !important;
        }
        
        .driver-item .btn:last-child {
            margin-bottom: 0;
        }
    }
    
    /* Tablet styles */
    @media (min-width: 768px) and (max-width: 991.98px) {
        .page-header {
            flex-direction: row;
            align-items: center !important;
        }
        
        .page-header h2 {
            font-size: 1.75rem;
            text-align: left;
            margin-bottom: 0;
        }
        
        .page-header .btn {
            width: auto;
        }
    }
    
    /* Desktop styles */
    @media (min-width: 992px) {
        .page-header {
            flex-direction: row;
            align-items: center !important;
        }
        
        .page-header h2 {
            font-size: 2rem;
            text-align: left;
            margin-bottom: 0;
        }
        
        .page-header .btn {
            width: auto;
        }
    }
    
    /* Touch-friendly improvements */
    .btn, .form-control, .form-select {
        touch-action: manipulation;
    }
    
    /* Improved spacing for mobile */
    .mb-4 {
        margin-bottom: 1.5rem !important;
    }
    
    @media (max-width: 767.98px) {
        .mb-4 {
            margin-bottom: 1rem !important;
        }
    }
    
    /* Enhanced form styling for mobile */
    .form-control, .form-select {
        border-radius: 0.5rem;
        border: 1px solid #dee2e6;
        transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
    }
    
    .form-control:focus, .form-select:focus {
        border-color: #86b7fe;
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
    }
    
    /* Improved card styling */
    .card {
        border-radius: 0.75rem;
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        border: 1px solid rgba(0, 0, 0, 0.125);
    }
    
    .card-header {
        border-radius: 0.75rem 0.75rem 0 0 !important;
        background-color: #f8f9fa;
        border-bottom: 1px solid rgba(0, 0, 0, 0.125);
    }
</style>
{% endblock %}

{% block extra_js %}
<script>

// Define the handler at the very beginning to ensure it's available
function handleSaveDriver() {
    const firstName = document.getElementById('first_name').value;
    const middleName = document.getElementById('middle_name').value;
    const lastName = document.getElementById('last_name').value;
    const username = document.getElementById('username').value;
    const email = document.getElementById('email').value;
    const password = document.getElementById('password').value;
    const confirmPassword = document.getElementById('confirm_password').value;
    const isActive = document.getElementById('is_active').checked;
    
    if (!username || !email || !password || !confirmPassword) {
        showToast('Validation Error', 'Please fill in all required fields.', 'error');
        return;
    }
    
    if (password !== confirmPassword) {
        showToast('Validation Error', 'Passwords do not match.', 'error');
        return;
    }
    
    submitDriverForm(firstName, middleName, lastName, username, email, password, isActive);
}

    // Toast notification function is now globally available from base.html

function submitDriverForm(firstName, middleName, lastName, username, email, password, isActive) {
    // Show loading indicator
    const saveBtn = document.getElementById('saveDriverBtn');
    const originalText = saveBtn.innerHTML;
    saveBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Saving...';
    saveBtn.disabled = true;
    
    // Get profile image file if selected
    const profileImageInput = document.getElementById('profile_image');
    const profileImageFile = profileImageInput.files.length > 0 ? profileImageInput.files[0] : null;
    
    fetch('/operator/drivers/add', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            first_name: firstName,
            middle_name: middleName,
            last_name: lastName,
            username,
            email,
            password,
            is_active: isActive
        }),
        credentials: 'same-origin'
    })
    .then(async response => {
        console.log('Backend response status:', response.status);
        
        // Check if response is redirect (authentication issue)
        if (response.redirected) {
            console.log('⚠️ Response was redirected - likely authentication issue');
            saveBtn.innerHTML = originalText;
            saveBtn.disabled = false;
            showToast('Session Expired', 'Please log in again.', 'error');
            setTimeout(() => window.location.href = '/login', 1500);
            return Promise.reject('redirected');
        }
        
        // Parse JSON response
        const data = await response.json();
        console.log('Backend response data:', data);
        
        // Handle response based on status
        if (response.ok) {
            // Success (200-299)
            if (data.success) {
                const driverId = data.driver.id;
                
                // Upload profile image if selected
                if (profileImageFile && driverId) {
                    try {
                        await uploadDriverImage(driverId, profileImageFile);
                    } catch (imageError) {
                        console.error('Error uploading profile image:', imageError);
                        // Don't fail the entire operation if image upload fails
                        showToast('Warning', 'Driver added but image upload failed. You can upload it later.', 'warning');
                    }
                }
                
                showToast('Success', 'Driver added successfully!', 'success');
                
                // Close modal
                const addModal = bootstrap.Modal.getInstance(document.getElementById('addDriverModal'));
                if (addModal) {
                    addModal.hide();
                }
                
                // Reset form
                document.getElementById('addDriverForm').reset();
                document.getElementById('profile_image_preview').style.display = 'none';
                
                // Refresh driver list via AJAX
                setTimeout(() => {
                    refreshDriverList();
                }, 500);
            } else {
                saveBtn.innerHTML = originalText;
                saveBtn.disabled = false;
                showToast('Error', data.error || 'Failed to add driver', 'error');
            }
        } else {
            // Error (400+)
            saveBtn.innerHTML = originalText;
            saveBtn.disabled = false;
            showToast('Error', data.error || `Server error (${response.status})`, 'error');
        }
    })
    .catch(error => {
        // Restore button state if not already restored
        if (saveBtn.disabled) {
            saveBtn.innerHTML = originalText;
            saveBtn.disabled = false;
        }
        
        // Don't show toast if it was a redirect (already handled)
        if (error === 'redirected') {
            return;
        }
        
        // Show user-friendly error message
        showToast('Connection Error', 'Unable to add driver. Please check your connection and try again.', 'error');
        
        // Check if it's a JSON parsing error (likely HTML response)
        if (error.message && error.message.includes('Unexpected token')) {
            // Redirect to login page
            setTimeout(() => window.location.href = '/login', 1500);
        }
    });
}

// Function to upload driver profile image
async function uploadDriverImage(driverId, imageFile) {
    const formData = new FormData();
    formData.append('profile_image', imageFile);
    formData.append('driver_id', driverId);
    
    const response = await fetch('/operator/drivers/profile-picture/upload', {
        method: 'POST',
        body: formData,
        credentials: 'same-origin'
    });
    
    const data = await response.json();
    
    if (!response.ok) {
        throw new Error(data.error || 'Failed to upload image');
    }
    
    return data;
}

// Function to preview image before upload
function previewImage(input, previewId, previewImgId) {
    const preview = document.getElementById(previewId);
    const previewImg = document.getElementById(previewImgId);
    
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        
        reader.onload = function(e) {
            previewImg.src = e.target.result;
            preview.style.display = 'block';
        };
        
        reader.readAsDataURL(input.files[0]);
    } else {
        preview.style.display = 'none';
    }
}
</script>
{% endblock %}

{% block content %}
<script>
// Prevent all form submissions to avoid page reloads
document.addEventListener('DOMContentLoaded', function() {
    document.addEventListener('submit', function(e) {
        e.preventDefault();
        e.stopPropagation();
        return false;
    }, true);
});

// Define refreshDriverList IMMEDIATELY - before any onclick handlers that use it
window.refreshDriverList = async function() {
    try {
        // Add cache-busting timestamp to force fresh fetch
        const cacheBuster = new Date().getTime();
        const response = await fetch(`/operator/drivers/manage?_=${cacheBuster}`, {
            method: 'GET',
            credentials: 'same-origin',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'Cache-Control': 'no-cache, no-store, must-revalidate',
                'Pragma': 'no-cache'
            }
        });
        
        if (response.ok) {
            let html = await response.text();
            
            // Add fresh timestamp to all profile image URLs BEFORE inserting into DOM
            // This prevents browser from loading cached images
            const freshTimestamp = new Date().getTime();
            
            // Improved regex: matches URLs with or without existing query params
            html = html.replace(
                /src="([^"]*\/uploads\/profiles\/[^"]*\.(jpg|jpeg|png|gif|webp))(\?[^"]*)?"/gi,
                (match, baseUrl, ext, existingQuery) => {
                    return `src="${baseUrl}?v=${freshTimestamp}"`;
                }
            );
            
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            
            // Find the driver table container
            const newTable = doc.querySelector('.table-responsive');
            const currentTable = document.querySelector('.table-responsive');
            
            if (newTable && currentTable) {
                currentTable.innerHTML = newTable.innerHTML;
                
                // Force browser to recognize the change by triggering a reflow
                currentTable.offsetHeight;
                
                // Reinitialize action buttons after refresh
                setTimeout(() => {
                    if (typeof initializeActionButtons === 'function') {
                        initializeActionButtons();
                    } else if (typeof attachActionButtonHandlers === 'function') {
                        attachActionButtonHandlers();
                    }
                }, 100);
            }
        }
    } catch (error) {
        console.error('Error refreshing driver list:', error);
    }
};
</script>
<div class="container mt-4">
    <div class="card shadow-sm">
        <div class="card-header bg-primary text-white">
            <div class="d-flex justify-content-between align-items-center">
                <h3 class="mb-0">
                    <i class="fas fa-users me-2"></i>
                    Manage Drivers
                </h3>
                <div>
                    <button class="btn btn-light btn-sm" data-bs-toggle="modal" data-bs-target="#addDriverModal">
                        <i class="fas fa-plus me-1"></i> Add Driver
                    </button>
                </div>
            </div>
        </div>
        <div class="card-body">
            {% if drivers %}
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Username</th>
                                <th>Email</th>
                                <th>Status</th>
                                <th>Created</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for driver in drivers %}
                                <tr>
                                    <td>
                                        {% if driver.profile_image_url %}
                                            <img src="{{ driver.profile_image_url }}" alt="Profile" class="rounded-circle me-2" style="width: 30px; height: 30px; object-fit: cover;">
                                        {% else %}
                                            {% set driver_name = driver.get_full_name() if driver.get_full_name() else driver.username %}
                                            {% set placeholder_url = "https://ui-avatars.com/api/?name=" + driver_name|urlencode + "&size=64&background=667eea&color=fff&bold=true&font-size=0.33" %}
                                            <img src="{{ placeholder_url }}" alt="Profile" class="rounded-circle me-2" style="width: 30px; height: 30px; object-fit: cover;">
                                        {% endif %}
                                        {{ driver.get_full_name() }}
                                    </td>
                                    <td>{{ driver.username }}</td>
                                    <td>{{ driver.email }}</td>
                                    <td>
                                        {% if driver.is_active %}
                                            <span class="badge bg-success">Active</span>
                                        {% else %}
                                            <span class="badge bg-danger">Inactive</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ driver.created_at.strftime('%Y-%m-%d') }}</td>
                                    <td>
                                        <div class="btn-group btn-group-sm">
                                            <button class="btn btn-outline-primary view-driver" data-driver-id="{{ driver.id }}" onclick="loadDriverDetails('{{ driver.id }}'); return false;">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            <button class="btn btn-outline-secondary edit-driver" data-driver-id="{{ driver.id }}" onclick="loadDriverForEdit('{{ driver.id }}'); return false;">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            {% if driver.is_active %}
                                                <button class="btn btn-outline-danger deactivate-driver" data-driver-id="{{ driver.id }}" onclick="showConfirmation('Deactivate Driver', 'Are you sure you want to deactivate driver &quot;{{ driver.username }}&quot;? They will not be able to log in, but their data will be preserved.', function() { deactivateDriver('{{ driver.id }}'); }); return false;">
                                                    <i class="fas fa-user-slash"></i>
                                                </button>
                                            {% else %}
                                                <button class="btn btn-outline-success activate-driver" data-driver-id="{{ driver.id }}" onclick="showConfirmation('Activate Driver', 'Are you sure you want to activate driver &quot;{{ driver.username }}&quot;?', function() { activateDriver('{{ driver.id }}'); }); return false;">
                                                    <i class="fas fa-user-check"></i>
                                                </button>
                                            {% endif %}
                                            <button class="btn btn-outline-info reset-password" data-driver-id="{{ driver.id }}" onclick="loadDriverForPasswordReset('{{ driver.id }}'); return false;">
                                                <i class="fas fa-key"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div class="alert alert-info">
                    No drivers found. Click the "Add Driver" button to create one.
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Add Driver Modal -->
<div class="modal fade" id="addDriverModal" tabindex="-1" aria-hidden="true" style="z-index: 2100 !important;">
    <div class="modal-dialog" style="z-index: 2110 !important; position: relative;">
        <div class="modal-content" style="z-index: 2120 !important; position: relative;">
            <div class="modal-header">
                <h5 class="modal-title">Add New Driver</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addDriverForm" onsubmit="return false;">
                    <div class="mb-3">
                        <label for="first_name" class="form-label">First Name</label>
                        <input type="text" class="form-control" id="first_name" name="first_name">
                    </div>
                    <div class="mb-3">
                        <label for="middle_name" class="form-label">Middle Name</label>
                        <input type="text" class="form-control" id="middle_name" name="middle_name">
                    </div>
                    <div class="mb-3">
                        <label for="last_name" class="form-label">Last Name</label>
                        <input type="text" class="form-control" id="last_name" name="last_name">
                    </div>
                    <div class="mb-3">
                        <label for="username" class="form-label">Username</label>
                        <input type="text" class="form-control" id="username" name="username" required>
                        <div class="form-text">Username cannot be changed later.</div>
                    </div>
                    <div class="mb-3">
                        <label for="email" class="form-label">Email</label>
                        <input type="email" class="form-control" id="email" name="email" required>
                    </div>
                    <div class="mb-3">
                        <label for="password" class="form-label">Password</label>
                        <input type="password" class="form-control" id="password" name="password" required>
                    </div>
                    <div class="mb-3">
                        <label for="confirm_password" class="form-label">Confirm Password</label>
                        <input type="password" class="form-control" id="confirm_password" name="confirm_password" required>
                    </div>
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="is_active" name="is_active" checked>
                        <label class="form-check-label" for="is_active">Active</label>
                    </div>
                    <div class="mb-3">
                        <label for="profile_image" class="form-label">Profile Picture (Optional)</label>
                        <input type="file" class="form-control" id="profile_image" name="profile_image" accept="image/*">
                        <div class="form-text">Upload a profile picture for this driver (JPG, PNG, etc.)</div>
                        <div id="profile_image_preview" class="mt-2" style="display: none;">
                            <img id="profile_image_preview_img" src="" alt="Preview" style="max-width: 200px; max-height: 200px; border-radius: 50%; object-fit: cover;">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <!-- Use type="submit" to make this act like a form submit button -->
                <button type="button" class="btn btn-primary" id="saveDriverBtn" style="position: relative; z-index: 1100;">Save Driver</button>
                <script>
                    // Immediate event binding with preventDefault
                    document.getElementById('saveDriverBtn').addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        handleSaveDriver();
                    });
                </script>
            </div>
        </div>
    </div>
</div>

<!-- Edit Driver Modal -->
<div class="modal fade" id="editDriverModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Driver</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editDriverForm" onsubmit="return false;">
                    <input type="hidden" id="edit_driver_id" name="driver_id">
                    <div class="mb-3">
                        <label for="edit_username" class="form-label">Username</label>
                        <input type="text" class="form-control" id="edit_username" name="username" disabled>
                        <div class="form-text">Username cannot be changed.</div>
                    </div>
                    <div class="mb-3">
                        <label for="edit_email" class="form-label">Email</label>
                        <input type="email" class="form-control" id="edit_email" name="email" required>
                    </div>
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="edit_is_active" name="is_active">
                        <label class="form-check-label" for="edit_is_active">Active</label>
                    </div>
                    <div class="mb-3">
                        <label for="edit_profile_image" class="form-label">Profile Picture</label>
                        <div id="edit_profile_image_current" class="mb-2"></div>
                        <input type="file" class="form-control" id="edit_profile_image" name="profile_image" accept="image/*">
                        <div class="form-text">Upload a new profile picture to replace the current one</div>
                        <div id="edit_profile_image_preview" class="mt-2" style="display: none;">
                            <img id="edit_profile_image_preview_img" src="" alt="Preview" style="max-width: 200px; max-height: 200px; border-radius: 50%; object-fit: cover;">
                        </div>
                        <button type="button" class="btn btn-sm btn-outline-danger mt-2" id="remove_profile_image_btn" style="display: none;">
                            <i class="fas fa-trash me-1"></i> Remove Picture
                        </button>
                    </div>
                </form>
            </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="updateDriverBtn" data-handler-attached="true">Update Driver</button>
                </div>
            </div>
        </div>
    </div>
    <script>
    // PREVENT FORM SUBMISSION IN EDIT MODAL
    (function() {
        const editForm = document.getElementById('editDriverForm');
        if (editForm) {
            editForm.addEventListener('submit', function(e) {
                e.preventDefault();
                e.stopPropagation();
                return false;
            }, true);
        }
    })();
    
    // ATTACH LISTENER IMMEDIATELY - ALL LOGIC INLINE
    (function() {
        const btn = document.getElementById('updateDriverBtn');
        if (btn) {
            // Mark button to prevent driver_actions.js from attaching its listener
            btn.setAttribute('data-custom-handler', 'true');
            
            btn.onclick = async function(e) {
                e.preventDefault();
                e.stopPropagation();
                e.stopImmediatePropagation();
                
                const driverId = document.getElementById('edit_driver_id').value;
                const email = document.getElementById('edit_email').value;
                const isActive = document.getElementById('edit_is_active').checked;
                const fileInput = document.getElementById('edit_profile_image');
                const profileImageFile = (fileInput && fileInput.files && fileInput.files.length > 0) ? fileInput.files[0] : null;
                
                // UPLOAD IMAGE FIRST if file exists
                if (profileImageFile) {
                    showToast('Processing', 'Uploading profile picture...', 'info');
                    
                    const formData = new FormData();
                    formData.append('profile_image', profileImageFile);
                    formData.append('driver_id', driverId);
                    
                    try {
                        const uploadResponse = await fetch('/operator/drivers/profile-picture/upload', {
                            method: 'POST',
                            body: formData,
                            credentials: 'same-origin'
                        });
                        
                        const uploadData = await uploadResponse.json();
                        
                        if (!uploadResponse.ok) {
                            showToast('Error', 'Image upload failed: ' + (uploadData.error || 'Unknown error'), 'error');
                            return false;
                        }
                        
                        showToast('Success', 'Profile picture uploaded!', 'success');
                    } catch (uploadError) {
                        console.error('Upload error:', uploadError);
                        showToast('Error', 'Image upload failed: ' + uploadError.message, 'error');
                        return false;
                    }
                }
                
                // NOW UPDATE DRIVER INFO
                btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Updating...';
                btn.disabled = true;
                
                try {
                    const updateResponse = await fetch(`/operator/drivers/${driverId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email, is_active: isActive }),
                        credentials: 'same-origin'
                    });
                    
                    const updateData = await updateResponse.json();
                    
                    if (updateResponse.ok) {
                        showToast('Success', 'Driver updated successfully!', 'success');
                        
                        // Close modal
                        const editModal = bootstrap.Modal.getInstance(document.getElementById('editDriverModal'));
                        if (editModal) editModal.hide();
                        
                        // Refresh list via AJAX - wait for database commit and file system sync
                        if (typeof window.refreshDriverList === 'function') {
                            setTimeout(() => {
                                window.refreshDriverList();
                            }, 800);
                        }
                    } else {
                        showToast('Error', updateData.error || 'Update failed', 'error');
                    }
                } catch (updateError) {
                    console.error('Update error:', updateError);
                    showToast('Error', 'Update failed: ' + updateError.message, 'error');
                } finally {
                    btn.innerHTML = 'Update Driver';
                    btn.disabled = false;
                }
                
                return false;
            };
        }
    })();
    </script>

<!-- Reset Password Modal -->
<div class="modal fade" id="resetPasswordModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Reset Driver Password</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="resetPasswordForm">
                    <input type="hidden" id="reset_driver_id" name="driver_id">
                    <div class="mb-3">
                        <label for="reset_username" class="form-label">Username</label>
                        <input type="text" class="form-control" id="reset_username" disabled>
                    </div>
                    <div class="mb-3">
                        <label for="new_password" class="form-label">New Password</label>
                        <input type="password" class="form-control" id="new_password" name="new_password" required>
                    </div>
                    <div class="mb-3">
                        <label for="confirm_new_password" class="form-label">Confirm New Password</label>
                        <input type="password" class="form-control" id="confirm_new_password" name="confirm_new_password" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="resetPasswordBtn">Reset Password</button>
            </div>
        </div>
    </div>
</div>

<!-- View Driver Modal -->
<div class="modal fade" id="viewDriverModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Driver Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="text-center mb-4">
                    <div id="profileImageContainer" class="mb-3 text-center">
                        <img id="profileImage" src="" alt="Profile" class="rounded-circle" style="width: 100px; height: 100px; object-fit: cover; border: 3px solid #667eea; margin: 0 auto;">
                        <div id="profilePlaceholder" class="rounded-circle bg-secondary d-flex align-items-center justify-content-center" style="width: 100px; height: 100px; margin: 0 auto; display: none;">
                            <i class="fas fa-user text-white" style="font-size: 40px;"></i>
                        </div>
                    </div>
                    <h4 id="viewDriverName"></h4>
                    <p id="viewDriverEmail" class="text-muted"></p>
                    <div id="viewDriverStatus" class="badge bg-success mb-3">Active</div>
                </div>
                
                <div class="driver-info">
                    <div class="row mb-2">
                        <div class="col-4 fw-bold">ID:</div>
                        <div class="col-8" id="viewDriverId"></div>
                    </div>
                    <div class="row mb-2">
                        <div class="col-4 fw-bold">Created:</div>
                        <div class="col-8" id="viewDriverCreated"></div>
                    </div>
                    <div class="row mb-2">
                        <div class="col-4 fw-bold">Assigned Vehicles:</div>
                        <div class="col-8" id="viewDriverVehicles"></div>
                    </div>
                    <div class="row mb-2">
                        <div class="col-4 fw-bold">Recent Activity:</div>
                        <div class="col-8" id="viewDriverActivity"></div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Confirmation Modal -->
<div class="modal fade" id="confirmationModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="confirmationTitle">Confirm Action</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="confirmationMessage">
                Are you sure you want to proceed?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirmButton">Confirm</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let pendingAction = null;
    let pendingDriverId = null;
    
    // PREVENT ALL FORM SUBMISSIONS - CRITICAL FIX FOR PAGE RELOAD
    document.addEventListener('submit', function(e) {
        e.preventDefault();
        e.stopPropagation();
        return false;
    }, true); // Use capture phase to catch early

    // Global function to handle saving driver
    window.handleSaveDriver = function() {
        console.log('Save Driver button clicked (inline handler)');
            const firstName = document.getElementById('first_name').value;
            const middleName = document.getElementById('middle_name').value;
            const lastName = document.getElementById('last_name').value;
            const username = document.getElementById('username').value;
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const confirmPassword = document.getElementById('confirm_password').value;
            const isActive = document.getElementById('is_active').checked;
        
        console.log('Form values:', { firstName, middleName, lastName, username, email, isActive });
            
            if (!username || !email || !password || !confirmPassword) {
                showToast('Validation Error', 'Please fill in all required fields.', 'error');
                console.log('Form validation failed: missing fields');
                return;
            }
            
            if (password !== confirmPassword) {
                showToast('Validation Error', 'Passwords do not match.', 'error');
                console.log('Form validation failed: passwords do not match');
                return;
            }
            
        console.log('Form validation passed, calling addDriver()');
            addDriver(firstName, middleName, lastName, username, email, password, isActive);
    }
    
    // Function to fix modal backdrop issue
    function fixModalBackdrop() {
        try {
            console.log('Fixing modal backdrop');
            
            // Check if document.body exists before proceeding
            if (!document.body) {
                console.warn('Document body not ready, skipping modal backdrop fix');
                return;
            }
            
            // Fix all button z-indices to be below modals, except buttons inside modals
            const buttons = document.querySelectorAll('.btn:not(.modal .btn)');
            if (buttons.length > 0) {
                buttons.forEach(btn => {
                    if (btn && btn.style) {
                        btn.style.zIndex = '1039';
                        btn.style.position = 'relative';
                    }
                });
            }
            
            // Remove any existing modal backdrop
            const existingBackdrops = document.querySelectorAll('.modal-backdrop');
            if (existingBackdrops.length > 0) {
                existingBackdrops.forEach(backdrop => {
                    if (backdrop && backdrop.style) {
                        backdrop.style.zIndex = '2000';  // Higher z-index for backdrop
                        backdrop.style.backgroundColor = 'rgba(0, 0, 0, 0.7)';
                        backdrop.style.opacity = '0.8';
                        backdrop.classList.add('fix-backdrop');
                    }
                });
            }
            
            // Special treatment for Add Driver Modal - don't touch its z-index settings
            const addDriverModal = document.getElementById('addDriverModal');
            if (addDriverModal && addDriverModal.style) {
                // Ensure it's above the backdrop
                addDriverModal.style.zIndex = '2100 !important';
            }
            
            // Make sure all other modals are above backdrop
            const modals = document.querySelectorAll('.modal:not(#addDriverModal)');
            if (modals.length > 0) {
                modals.forEach(modal => {
                    if (modal && modal.style) {
                        modal.style.zIndex = '2050';
                    }
                });
            }
            
            // Make sure modal content is above the modal itself for other modals
            const modalContents = document.querySelectorAll('.modal:not(#addDriverModal) .modal-content');
            if (modalContents.length > 0) {
                modalContents.forEach(content => {
                    if (content && content.style) {
                        content.style.zIndex = '2060';
                        content.style.position = 'relative';
                    }
                });
            }
            
            // Make sure modal dialog is above the modal itself for other modals
            const modalDialogs = document.querySelectorAll('.modal:not(#addDriverModal) .modal-dialog');
            if (modalDialogs.length > 0) {
                modalDialogs.forEach(dialog => {
                    if (dialog && dialog.style) {
                        dialog.style.zIndex = '2060';
                        dialog.style.position = 'relative';
                    }
                });
            }
            
            // Create custom backdrop if none exists
            if (existingBackdrops.length === 0) {
                console.log('Creating custom backdrop');
                const customBackdrop = document.createElement('div');
                customBackdrop.className = 'modal-backdrop fade show fix-backdrop';
                customBackdrop.style.zIndex = '2000';
                customBackdrop.style.backgroundColor = 'rgba(0, 0, 0, 0.7)';
                customBackdrop.style.opacity = '0.8';
                document.body.appendChild(customBackdrop);
            }
            
            // Add modal-open class to body if not already present
            if (document.body.classList) {
                document.body.classList.add('modal-open');
            }
            
            // Ensure buttons in the table have lower z-index
            const tableButtons = document.querySelectorAll('.btn-group .btn');
            if (tableButtons.length > 0) {
                tableButtons.forEach(btn => {
                    if (btn && btn.style) {
                        try {
                            const isInModal = btn.closest && btn.closest('.modal');
                            if (!isInModal) {
                                btn.style.zIndex = '1039';
                                btn.style.position = 'relative';
                            }
                        } catch (error) {
                            console.warn('Error checking if button is in modal:', error);
                            // Default to setting z-index if we can't determine modal status
                            btn.style.zIndex = '1039';
                            btn.style.position = 'relative';
                        }
                    }
                });
            }
            
            // Ensure the Add Driver button has lower z-index
            const addDriverBtn = document.querySelector('[data-bs-target="#addDriverModal"]');
            if (addDriverBtn && addDriverBtn.style) {
                addDriverBtn.style.zIndex = '1039';
                addDriverBtn.style.position = 'relative';
            }
        } catch (error) {
            console.error('Error in fixModalBackdrop:', error);
        }
    }

    // Console log to verify script is loaded
    console.log('Manage Drivers script loaded and running');
    
    // Ensure handleSaveDriver is really available in the global scope
    if (typeof window.handleSaveDriver === 'function') {
        console.log('handleSaveDriver is correctly defined in the global scope');
    } else {
        console.error('handleSaveDriver is NOT available in global scope!');
    }
    
    // Wait for DOM to be fully ready before initializing
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM fully loaded, initializing action buttons');
            attachActionButtonHandlers();
        });
    } else {
        console.log('DOM already loaded, initializing action buttons immediately');
        attachActionButtonHandlers();
    }
    
    // Initialize action buttons immediately and also after DOM is ready
    function attachActionButtonHandlers() {
        try {
            console.log('Initializing action buttons NOW');
            
            // First, log all buttons to verify they exist
            console.log('View buttons:', document.querySelectorAll('.view-driver').length);
            console.log('Edit buttons:', document.querySelectorAll('.edit-driver').length);
            console.log('Activate buttons:', document.querySelectorAll('.activate-driver').length);
            console.log('Deactivate buttons:', document.querySelectorAll('.deactivate-driver').length);
            console.log('Reset password buttons:', document.querySelectorAll('.reset-password').length);
            
            // Then initialize them
            initializeActionButtons();
        } catch (e) {
            console.error('Error initializing action buttons:', e);
        }
    }
    
    // Attach handlers immediately
    attachActionButtonHandlers();
    
    // Also attach after a short delay to ensure DOM is fully processed
    setTimeout(attachActionButtonHandlers, 500);
    
    // And once more after a longer delay as a fallback
    setTimeout(attachActionButtonHandlers, 1500);
    
    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM content loaded');
        
        // Direct event handler for the save button as a backup
        const saveBtn = document.getElementById('saveDriverBtn');
        if (saveBtn) {
            console.log('Save button found, attaching direct event listener');
            saveBtn.addEventListener('click', function(e) {
                console.log('Save button clicked via direct event listener');
                window.handleSaveDriver();
            });
        } else {
            console.error('Save button not found in DOM!');
        }
        
        // Action button event handlers - reinitialize to ensure they work
        console.log('Reinitializing action buttons on DOMContentLoaded');
        initializeActionButtons();
        
        // Add event listener for any modal being shown
        document.body.addEventListener('shown.bs.modal', function() {
            fixModalBackdrop();
        });
        
        // Add click event to Add Driver button to manually fix backdrop and ensure it works
        const addDriverBtn = document.querySelector('[data-bs-target="#addDriverModal"]');
        if (addDriverBtn) {
            // Replace with a new element to ensure clean event listeners
            const newBtn = addDriverBtn.cloneNode(true);
            addDriverBtn.parentNode.replaceChild(newBtn, addDriverBtn);
            
            // Add event listeners
            newBtn.addEventListener('click', function(e) {
                console.log('Add Driver button clicked');
                setTimeout(fixModalBackdrop, 10);
            });
            
            // Ensure button is clickable
            newBtn.style.cursor = 'pointer';
            newBtn.style.position = 'relative';
            newBtn.style.zIndex = '1039';
        }
        
        // Override all modal show functions to ensure proper z-index
        function initializeModals() {
            const modalEls = document.querySelectorAll('.modal');
            modalEls.forEach(modalEl => {
                const modalId = modalEl.id;
                const originalModal = bootstrap.Modal.getInstance(modalEl);
                if (originalModal) {
                    const originalShow = originalModal.show;
                    originalModal.show = function() {
                        originalShow.call(this);
                        setTimeout(fixModalBackdrop, 10);
                    };
                }
            });
        }
        
        // Initialize modals after page load
        setTimeout(initializeModals, 500);
        // Add driver form submission
        document.getElementById('saveDriverBtn').addEventListener('click', function() {
            console.log('Save Driver button clicked');
            const firstName = document.getElementById('first_name').value;
            const middleName = document.getElementById('middle_name').value;
            const lastName = document.getElementById('last_name').value;
            const username = document.getElementById('username').value;
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const confirmPassword = document.getElementById('confirm_password').value;
            const isActive = document.getElementById('is_active').checked;
            
            console.log('Form values:', { firstName, middleName, lastName, username, email, isActive });
            
            if (!username || !email || !password || !confirmPassword) {
                showToast('Validation Error', 'Please fill in all required fields.', 'error');
                console.log('Form validation failed: missing fields');
                return;
            }
            
            if (password !== confirmPassword) {
                showToast('Validation Error', 'Passwords do not match.', 'error');
                console.log('Form validation failed: passwords do not match');
                return;
            }
            
            console.log('Form validation passed, calling addDriver()');
            addDriver(firstName, middleName, lastName, username, email, password, isActive);
        });
        
        // Initialize action buttons function
        function initializeActionButtons() {
            console.log('Initializing action buttons');
            
            // Direct binding function for each button to ensure they work
            function bindActionButton(selector, handler) {
                const buttons = document.querySelectorAll(selector);
                console.log(`Found ${buttons.length} ${selector} buttons`);
                
                buttons.forEach((button, index) => {
                    // Remove any existing event listeners
                    const newButton = button.cloneNode(true);
                    button.parentNode.replaceChild(newButton, button);
                    
                    // Add new event listener
                    newButton.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                const driverId = this.getAttribute('data-driver-id');
                        const row = this.closest('tr');
                        let username = 'driver';
                        
                        if (row) {
                            const firstCell = row.querySelector('td:first-child');
                            if (firstCell) {
                                username = firstCell.textContent.trim();
                            }
                        }
                        
                        console.log(`Button ${selector} #${index} clicked for ${username} (ID: ${driverId})`);
                        handler.call(this, driverId, username);
                    });
                    
                    // Make sure the button is clickable
                    newButton.style.cursor = 'pointer';
                    newButton.style.zIndex = '1100';
                    newButton.style.position = 'relative';
                });
            }
            
            // View driver buttons
            bindActionButton('.view-driver', function(driverId, username) {
                console.log(`View driver clicked for ${username} (ID: ${driverId})`);
                loadDriverDetails(driverId);
            });
            
            // Edit driver buttons
            bindActionButton('.edit-driver', function(driverId, username) {
                console.log(`Edit driver clicked for ${username} (ID: ${driverId})`);
                loadDriverForEdit(driverId);
            });
            
            // Activate driver buttons
            bindActionButton('.activate-driver', function(driverId, username) {
                console.log(`Activate driver clicked for ${username} (ID: ${driverId})`);
                showConfirmation(
                    'Activate Driver',
                    `Are you sure you want to activate driver "${username}"?`,
                    () => activateDriver(driverId)
                );
            });
            
            // Deactivate driver buttons
            bindActionButton('.deactivate-driver', function(driverId, username) {
                console.log(`Deactivate driver clicked for ${username} (ID: ${driverId})`);
                showConfirmation(
                    'Deactivate Driver',
                    `Are you sure you want to deactivate driver "${username}"? They will not be able to log in, but their data will be preserved.`,
                    () => deactivateDriver(driverId)
                );
        });
        
        // Reset password buttons
            bindActionButton('.reset-password', function(driverId, username) {
                console.log(`Reset password clicked for ${username} (ID: ${driverId})`);
                loadDriverForPasswordReset(driverId);
            });
        }
        
        // Update driver form submission
        const updateDriverBtn = document.getElementById('updateDriverBtn');
        if (updateDriverBtn) {
            // Remove any existing listeners first
            const newBtn = updateDriverBtn.cloneNode(true);
            updateDriverBtn.parentNode.replaceChild(newBtn, updateDriverBtn);
            
            newBtn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                
                const driverId = document.getElementById('edit_driver_id').value;
                const email = document.getElementById('edit_email').value;
                const isActive = document.getElementById('edit_is_active').checked;
                
                if (!email) {
                    showToast('Validation Error', 'Please fill in all required fields.', 'error');
                    return;
                }
                
                updateDriver(driverId, email, isActive);
            });
        }
        
        // Image preview event listeners
        const profileImageInput = document.getElementById('profile_image');
        if (profileImageInput) {
            profileImageInput.addEventListener('change', function() {
                previewImage(this, 'profile_image_preview', 'profile_image_preview_img');
            });
        }
        
        const editProfileImageInput = document.getElementById('edit_profile_image');
        if (editProfileImageInput) {
            editProfileImageInput.addEventListener('change', function() {
                previewImage(this, 'edit_profile_image_preview', 'edit_profile_image_preview_img');
            });
        }
        
        // Remove image button event listener
        const removeImageBtn = document.getElementById('remove_profile_image_btn');
        if (removeImageBtn) {
            removeImageBtn.addEventListener('click', function() {
                const driverId = document.getElementById('edit_driver_id').value;
                if (driverId) {
                    removeDriverImage(driverId);
                }
            });
        }
        
        // Reset password form submission
        const resetPasswordBtn = document.getElementById('resetPasswordBtn');
        if (resetPasswordBtn) {
            resetPasswordBtn.addEventListener('click', function() {
            const driverId = document.getElementById('reset_driver_id').value;
            const newPassword = document.getElementById('new_password').value;
            const confirmNewPassword = document.getElementById('confirm_new_password').value;
            
            if (!newPassword || !confirmNewPassword) {
                    showToast('Validation Error', 'Please fill in all required fields.', 'error');
                return;
            }
            
            if (newPassword !== confirmNewPassword) {
                    showToast('Validation Error', 'Passwords do not match.', 'error');
                return;
            }
            
            resetDriverPassword(driverId, newPassword);
        });
        }
    });
    
    // Making addDriver a global function to be accessible from anywhere
    window.addDriver = async function(firstName, middleName, lastName, username, email, password, isActive) {
        try {
            // Show loading state on the Save Driver button
            const saveBtn = document.getElementById('saveDriverBtn');
            const originalText = saveBtn.innerHTML;
            saveBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Saving...';
            saveBtn.disabled = true;
            
            const requestBody = {
                    first_name: firstName,
                    middle_name: middleName,
                    last_name: lastName,
                    username,
                    email,
                    password,
                    is_active: isActive
            };
            
            // Get CSRF token if it exists (for Flask)
            const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');
            
            const headers = {
                'Content-Type': 'application/json'
            };
            
            // Add CSRF token if available
            if (csrfToken) {
                headers['X-CSRFToken'] = csrfToken;
            }
            
            const response = await fetch('/operator/drivers/add', {
                method: 'POST',
                headers: headers,
                body: JSON.stringify(requestBody),
                credentials: 'same-origin'
            });
            
            const data = await response.json();
            
            // Handle response
            if (response.ok) {
                showToast('Success', 'Driver added successfully!', 'success');
                // Reset button state
                saveBtn.innerHTML = originalText;
                saveBtn.disabled = false;
                // Close modal and refresh
                const addModal = bootstrap.Modal.getInstance(document.getElementById('addDriverModal'));
                if (addModal) addModal.hide();
                setTimeout(() => refreshDriverList(), 500);
                return;
            } else {
                const errorMsg = data.error || 'Failed to add driver.';
                showToast('Error', errorMsg, 'error');
            }
        } catch (error) {
            console.error('Error adding driver:', error);
            
            // Reset button state in case of error
            const saveBtn = document.getElementById('saveDriverBtn');
            if (saveBtn) {
                saveBtn.innerHTML = 'Save Driver';
                saveBtn.disabled = false;
            }
            
            showToast('Error', 'An error occurred while adding the driver.', 'error');
        }
    }
    
    // Make all action functions globally available
    window.loadDriverForEdit = async function(driverId) {
        try {
            const response = await fetch(`/operator/drivers/${driverId}`);
            const data = await response.json();
            
            if (response.ok) {
                document.getElementById('edit_driver_id').value = data.driver.id;
                document.getElementById('edit_username').value = data.driver.username;
                document.getElementById('edit_email').value = data.driver.email;
                document.getElementById('edit_is_active').checked = data.driver.is_active;
                
                // Display current profile image if exists, or show placeholder
                const currentImageContainer = document.getElementById('edit_profile_image_current');
                const removeImageBtn = document.getElementById('remove_profile_image_btn');
                const driverName = data.driver.full_name || data.driver.username || 'Driver';
                const encodedName = encodeURIComponent(driverName);
                
                if (data.driver.profile_image_url) {
                    currentImageContainer.innerHTML = `
                        <img src="${data.driver.profile_image_url}" alt="Current Profile Picture" 
                             style="max-width: 150px; max-height: 150px; border-radius: 50%; object-fit: cover; border: 2px solid #dee2e6;">
                        <div class="form-text mt-2">Current profile picture</div>
                    `;
                    removeImageBtn.style.display = 'inline-block';
                } else {
                    // Show placeholder image
                    const placeholderUrl = `https://ui-avatars.com/api/?name=${encodedName}&size=300&background=667eea&color=fff&bold=true&font-size=0.5`;
                    currentImageContainer.innerHTML = `
                        <img src="${placeholderUrl}" alt="Placeholder Profile Picture" 
                             style="max-width: 150px; max-height: 150px; border-radius: 50%; object-fit: cover; border: 2px solid #dee2e6;">
                        <div class="form-text mt-2">No profile picture (placeholder shown)</div>
                    `;
                    removeImageBtn.style.display = 'none';
                }
                
                // DON'T reset the file input - keep any selected file for upload
                // Only reset the preview if no file is currently selected
                const fileInput = document.getElementById('edit_profile_image');
                if (fileInput && (!fileInput.files || fileInput.files.length === 0)) {
                    document.getElementById('edit_profile_image_preview').style.display = 'none';
                }
                
                // Show the modal with proper backdrop fix
                const modal = new bootstrap.Modal(document.getElementById('editDriverModal'));
                modal.show();
                setTimeout(fixModalBackdrop, 10);
            } else {
                showToast('Error', data.error || 'Failed to load driver details.', 'error');
                console.error('Error response from backend:', data);
            }
        } catch (error) {
            console.error('Error loading driver:', error);
            showToast('Error', 'An error occurred while loading the driver details.', 'error');
        }
    }
    
    window.updateDriver = async function(driverId, email, isActive) {
        try {
            // Check for file FIRST, BEFORE any other operations
            const profileImageInput = document.getElementById('edit_profile_image');
            
            if (profileImageInput) {
                const hasFiles = profileImageInput.files && profileImageInput.files.length > 0;
                
                if (hasFiles) {
                    const profileImageFile = profileImageInput.files[0];
                    
                    // UPLOAD FILE FIRST, BEFORE updating driver
                    try {
                        showToast('Processing', 'Uploading profile picture...', 'info');
                        
                        const uploadResult = await uploadDriverImage(driverId, profileImageFile);
                        
                        if (uploadResult && uploadResult.success) {
                            showToast('Success', 'Profile picture uploaded!', 'success');
                        } else {
                            showToast('Error', 'Image upload failed.', 'error');
                            return;
                        }
                    } catch (imageError) {
                        showToast('Error', 'Image upload failed: ' + imageError.message, 'error');
                        return;
                    }
                }
            }
            
            // Now update driver info
            const updateBtn = document.getElementById('updateDriverBtn');
            const originalText = updateBtn.textContent;
            updateBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Updating...';
            updateBtn.disabled = true;
            
            const response = await fetch(`/operator/drivers/${driverId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    email,
                    is_active: isActive
                }),
                credentials: 'same-origin'
            });
            
            const data = await response.json();
            
            if (response.ok) {
                showToast('Success', 'Driver updated successfully!', 'success');
                
                // Close modal
                const editModal = bootstrap.Modal.getInstance(document.getElementById('editDriverModal'));
                if (editModal) {
                    editModal.hide();
                }
                
                // Reset button state
                updateBtn.innerHTML = originalText;
                updateBtn.disabled = false;
                
                // Refresh driver list via AJAX
                if (typeof window.refreshDriverList === 'function') {
                    window.refreshDriverList();
                }
            } else {
                // Reset button state on error
                updateBtn.innerHTML = originalText;
                updateBtn.disabled = false;
                showToast('Error', data.error || 'Failed to update driver.', 'error');
            }
        } catch (error) {
            console.error('Error updating driver:', error);
            const updateBtn = document.getElementById('updateDriverBtn');
            if (updateBtn) {
                updateBtn.innerHTML = 'Update Driver';
                updateBtn.disabled = false;
            }
            showToast('Error', 'An error occurred while updating the driver.', 'error');
        }
    }
    
    // refreshDriverList is now defined at the top of the page (line ~414)
    // This ensures it's available when onclick handlers are created
    
    // Function to remove profile image
    window.removeDriverImage = async function(driverId) {
        try {
            if (!confirm('Are you sure you want to remove the profile picture?')) {
                return;
            }
            
            const response = await fetch('/operator/drivers/profile-picture/remove', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    driver_id: driverId
                }),
                credentials: 'same-origin'
            });
            
            const data = await response.json();
            
            if (response.ok) {
                showToast('Success', 'Profile picture removed successfully!', 'success');
                // Update the current image display
                // Show placeholder image after removal
                const driverName = document.getElementById('edit_username').value || 'Driver';
                const encodedName = encodeURIComponent(driverName);
                const placeholderUrl = `https://ui-avatars.com/api/?name=${encodedName}&size=300&background=667eea&color=fff&bold=true&font-size=0.5`;
                document.getElementById('edit_profile_image_current').innerHTML = `
                    <img src="${placeholderUrl}" alt="Placeholder Profile Picture" 
                         style="max-width: 150px; max-height: 150px; border-radius: 50%; object-fit: cover; border: 2px solid #dee2e6;">
                    <div class="form-text mt-2">No profile picture (placeholder shown)</div>
                `;
                document.getElementById('remove_profile_image_btn').style.display = 'none';
                setTimeout(() => refreshDriverList(), 500);
            } else {
                showToast('Error', data.error || 'Failed to remove profile picture.', 'error');
            }
        } catch (error) {
            console.error('Error removing profile image:', error);
            showToast('Error', 'An error occurred while removing the profile picture.', 'error');
        }
    }
    
    window.activateDriver = async function(driverId) {
        try {
            // Close the confirmation modal if it's open
            const confirmModal = bootstrap.Modal.getInstance(document.getElementById('confirmationModal'));
            if (confirmModal) confirmModal.hide();
            
            showToast('Processing', 'Activating driver...', 'info');
            
            const response = await fetch(`/operator/drivers/${driverId}/activate`, {
                method: 'POST',
                credentials: 'same-origin'
            });
            
            const data = await response.json();
            
            if (response.ok) {
                showToast('Success', 'Driver activated successfully!', 'success');
                setTimeout(() => refreshDriverList(), 500);
            } else {
                showToast('Error', data.error || 'Failed to activate driver.', 'error');
                console.error('Error response from backend:', data);
            }
        } catch (error) {
            console.error('Error activating driver:', error);
            showToast('Error', 'An error occurred while activating the driver.', 'error');
        }
    }
    
    window.deactivateDriver = async function(driverId) {
        try {
            // Close the confirmation modal if it's open
            const confirmModal = bootstrap.Modal.getInstance(document.getElementById('confirmationModal'));
            if (confirmModal) confirmModal.hide();
            
            showToast('Processing', 'Deactivating driver...', 'info');
            
            const response = await fetch(`/operator/drivers/${driverId}/deactivate`, {
                method: 'POST',
                credentials: 'same-origin'
            });
            
            const data = await response.json();
            
            if (response.ok) {
                showToast('Success', 'Driver deactivated successfully!', 'success');
                setTimeout(() => refreshDriverList(), 500);
            } else {
                showToast('Error', data.error || 'Failed to deactivate driver.', 'error');
                console.error('Error response from backend:', data);
            }
        } catch (error) {
            console.error('Error deactivating driver:', error);
            showToast('Error', 'An error occurred while deactivating the driver.', 'error');
        }
    }
    
    window.loadDriverForPasswordReset = async function(driverId) {
        try {
            const response = await fetch(`/operator/drivers/${driverId}`);
            const data = await response.json();
            
            if (response.ok) {
                // Clear any previous password inputs
                document.getElementById('new_password').value = '';
                document.getElementById('confirm_new_password').value = '';
                
                // Set driver details
                document.getElementById('reset_driver_id').value = data.driver.id;
                document.getElementById('reset_username').value = data.driver.username;
                
                // Show the modal with proper backdrop fix
                const modal = new bootstrap.Modal(document.getElementById('resetPasswordModal'));
                modal.show();
                setTimeout(fixModalBackdrop, 10);
            } else {
                showToast('Error', data.error || 'Failed to load driver details.', 'error');
                console.error('Error response from backend:', data);
            }
        } catch (error) {
            console.error('Error loading driver:', error);
            showToast('Error', 'An error occurred while loading the driver details.', 'error');
        }
    }
    
    window.resetDriverPassword = async function(driverId, newPassword) {
        try {
            // Show loading state
            const resetBtn = document.getElementById('resetPasswordBtn');
            const originalText = resetBtn.textContent;
            resetBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Resetting...';
            resetBtn.disabled = true;
            
            const response = await fetch(`/operator/drivers/${driverId}/reset-password`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    new_password: newPassword
                }),
                credentials: 'same-origin'
            });
            
            const data = await response.json();
            
            // Reset button state
            resetBtn.innerHTML = originalText;
            resetBtn.disabled = false;
            
            if (response.ok) {
                // Close the modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('resetPasswordModal'));
                if (modal) modal.hide();
                
                // Clear the form
                document.getElementById('new_password').value = '';
                document.getElementById('confirm_new_password').value = '';
                
                showToast('Success', 'Password reset successfully!', 'success');
            } else {
                showToast('Error', data.error || 'Failed to reset password.', 'error');
                console.error('Error response from backend:', data);
            }
        } catch (error) {
            console.error('Error resetting password:', error);
            
            // Reset button state
            const resetBtn = document.getElementById('resetPasswordBtn');
            if (resetBtn) {
                resetBtn.innerHTML = 'Reset Password';
                resetBtn.disabled = false;
            }
            
            showToast('Error', 'An error occurred while resetting the password.', 'error');
        }
    }
    
    window.loadDriverDetails = async function(driverId) {
        try {
            const response = await fetch(`/operator/drivers/${driverId}/details`);
            const data = await response.json();
            
            if (response.ok) {
                const driver = data.driver;
                
                // Update driver details in the modal
                document.getElementById('viewDriverName').textContent = driver.username;
                document.getElementById('viewDriverEmail').textContent = driver.email;
                document.getElementById('viewDriverId').textContent = driver.id;
                document.getElementById('viewDriverCreated').textContent = new Date(driver.created_at).toLocaleString();
                
                // Update status badge
                const statusBadge = document.getElementById('viewDriverStatus');
                statusBadge.textContent = driver.is_active ? 'Active' : 'Inactive';
                statusBadge.className = driver.is_active ? 'badge bg-success mb-3' : 'badge bg-danger mb-3';
                
                // Update profile image
                const profileImage = document.getElementById('profileImage');
                const profilePlaceholder = document.getElementById('profilePlaceholder');
                const driverName = driver.full_name || driver.username || 'Driver';
                const encodedName = encodeURIComponent(driverName);
                
                if (driver.profile_image_url) {
                    profileImage.src = driver.profile_image_url;
                    profileImage.style.display = 'block';
                    profilePlaceholder.style.display = 'none';
                } else {
                    // Show placeholder image instead of icon
                    const placeholderUrl = `https://ui-avatars.com/api/?name=${encodedName}&size=200&background=667eea&color=fff&bold=true&font-size=0.5`;
                    profileImage.src = placeholderUrl;
                    profileImage.style.display = 'block';
                    profilePlaceholder.style.display = 'none';
                }
                
                // Format assigned vehicles data
                let vehiclesHtml = 'No vehicles assigned';
                if (data.vehicles && data.vehicles.length > 0) {
                    vehiclesHtml = data.vehicles.map(v => 
                        `<span class="badge bg-info text-dark me-1 mb-1">${v.registration_number}</span>`
                    ).join(' ');
                }
                document.getElementById('viewDriverVehicles').innerHTML = vehiclesHtml;
                
                // Format recent activity with better display
                let activityHtml = 'No recent activity';
                if (data.recent_activity && data.recent_activity.length > 0) {
                    activityHtml = '<ul class="list-group list-group-flush">' +
                        data.recent_activity.map(a => 
                            `<li class="list-group-item bg-transparent py-1">
                                <i class="fas fa-history text-secondary me-2"></i>
                                ${a.action} 
                                <small class="text-muted">(${new Date(a.created_at).toLocaleString()})</small>
                             </li>`
                        ).join('') +
                        '</ul>';
                }
                document.getElementById('viewDriverActivity').innerHTML = activityHtml;
                
                // Show the modal with proper backdrop fix
                const modal = new bootstrap.Modal(document.getElementById('viewDriverModal'));
                modal.show();
                setTimeout(fixModalBackdrop, 10);
            } else {
                showToast('Error', data.error || 'Failed to load driver details.', 'error');
                console.error('Error response from backend:', data);
            }
        } catch (error) {
            console.error('Error loading driver details:', error);
            showToast('Error', 'An error occurred while loading the driver details.', 'error');
        }
    }
    
    window.showConfirmation = function(title, message, confirmCallback) {
        document.getElementById('confirmationTitle').textContent = title;
        document.getElementById('confirmationMessage').textContent = message;
        
        // Store the callback
        pendingAction = confirmCallback;
        
        // Set up confirm button
        document.getElementById('confirmButton').onclick = function() {
            if (pendingAction) {
                pendingAction();
            }
            bootstrap.Modal.getInstance(document.getElementById('confirmationModal')).hide();
        };
        
        // Show the modal
        const modal = new bootstrap.Modal(document.getElementById('confirmationModal'));
        modal.show();
        setTimeout(fixModalBackdrop, 10);
    }
</script>
{% endblock %}
