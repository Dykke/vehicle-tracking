{% extends 'base.html' %}

{% block title %}Vehicle Controls{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="card shadow-sm">
        <div class="card-header bg-primary text-white">
            <h3 class="mb-0">
                <i class="fas fa-bus me-2"></i>
                Vehicle Controls
            </h3>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <div class="vehicle-info mb-4">
                        <h4>Vehicle Information</h4>
                        <div id="vehicleDetails" class="p-3 border rounded">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <span class="fw-bold">Registration:</span>
                                <span id="vehicleRegistration">Loading...</span>
                            </div>
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <span class="fw-bold">Type:</span>
                                <span id="vehicleType">Loading...</span>
                            </div>
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <span class="fw-bold">Status:</span>
                                <span id="vehicleStatus">Loading...</span>
                            </div>
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <span class="fw-bold">Current Route:</span>
                                <span id="vehicleRoute">None</span>
                            </div>
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="fw-bold">Last Updated:</span>
                                <span id="vehicleLastUpdated">Never</span>
                            </div>
                        </div>
                    </div>

                    <div class="occupancy-controls mb-4">
                        <h4>Occupancy Status</h4>
                        <div class="p-3 border rounded">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <span class="fw-bold">Current Status:</span>
                                <span id="occupancyStatus" class="badge bg-success">Vacant</span>
                            </div>
                            <div class="btn-group w-100" role="group">
                                <button id="setVacant" class="btn btn-success flex-grow-1">
                                    <i class="fas fa-user-check me-2"></i>Set Vacant
                                </button>
                                <button id="setFull" class="btn btn-danger flex-grow-1">
                                    <i class="fas fa-user-times me-2"></i>Set Full
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-md-6">
                    <div class="route-controls mb-4">
                        <h4>Route Management</h4>
                        <div class="p-3 border rounded">
                            <div class="mb-3">
                                <label for="originInput" class="form-label">Origin</label>
                                <input type="text" class="form-control" id="originInput" placeholder="Enter origin location">
                            </div>
                            <div class="mb-3">
                                <label for="destinationInput" class="form-label">Destination</label>
                                <input type="text" class="form-control" id="destinationInput" placeholder="Enter destination location">
                            </div>
                            <div class="d-grid gap-2">
                                <button id="startRoute" class="btn btn-primary">
                                    <i class="fas fa-route me-2"></i>Start Route
                                </button>
                                <button id="abortRoute" class="btn btn-secondary" disabled>
                                    <i class="fas fa-ban me-2"></i>Abort Route
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="trip-controls mb-4">
                        <h4>Trip Management</h4>
                        <div class="p-3 border rounded">
                            <div id="noActiveTrip">
                                <p class="text-center text-muted">No active trip</p>
                                <div class="d-grid">
                                    <button id="startTrip" class="btn btn-success">
                                        <i class="fas fa-play-circle me-2"></i>Start Trip
                                    </button>
                                </div>
                            </div>
                            <div id="activeTrip" style="display: none;">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <span class="fw-bold">Trip ID:</span>
                                    <span id="tripId"></span>
                                </div>
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <span class="fw-bold">Started:</span>
                                    <span id="tripStartTime"></span>
                                </div>
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <span class="fw-bold">Passengers:</span>
                                    <span id="passengerCount">0</span>
                                </div>
                                <div class="passenger-actions d-flex gap-2 mb-3">
                                    <button id="passengerBoard" class="btn btn-sm btn-primary flex-grow-1">
                                        <i class="fas fa-arrow-right me-1"></i>Board
                                    </button>
                                    <button id="passengerAlight" class="btn btn-sm btn-secondary flex-grow-1">
                                        <i class="fas fa-arrow-left me-1"></i>Alight
                                    </button>
                                </div>
                                <div class="d-grid">
                                    <button id="endTrip" class="btn btn-danger">
                                        <i class="fas fa-stop-circle me-2"></i>End Trip
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div class="modal fade" id="confirmationModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="confirmationTitle">Confirm Action</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="confirmationMessage">
                    Are you sure you want to proceed?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="confirmButton">Confirm</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Passenger Count Modal -->
    <div class="modal fade" id="passengerCountModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="passengerCountTitle">Enter Passenger Count</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="passengerCountInput" class="form-label">Number of passengers:</label>
                        <input type="number" class="form-control" id="passengerCountInput" min="1" value="1">
                    </div>
                    <div class="mb-3">
                        <label for="passengerNotes" class="form-label">Notes (optional):</label>
                        <textarea class="form-control" id="passengerNotes" rows="2"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="confirmPassengerCount">Confirm</button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let currentVehicleId = null;
    let currentVehicleData = null;
    let currentTripId = null;
    let pendingAction = null;
    let pendingEventType = null;

    document.addEventListener('DOMContentLoaded', function() {
        // Get vehicle ID from URL parameter
        const urlParams = new URLSearchParams(window.location.search);
        currentVehicleId = urlParams.get('vehicle_id');
        
        if (!currentVehicleId) {
            alert('No vehicle ID provided');
            return;
        }
        
        // Load vehicle details
        loadVehicleDetails();
        
        // Check for active trip
        checkActiveTrip();
        
        // Set up event listeners
        setupEventListeners();
        
        // Set up real-time updates
        setupRealTimeUpdates();
    });
    
    // Real-time updates setup
    function setupRealTimeUpdates() {
        // Check if Socket.IO is available
        if (typeof io !== 'undefined') {
            const socket = io();
            
            // Join vehicle-specific room
            socket.emit('join_vehicle_room', { vehicle_id: currentVehicleId });
            
            // Listen for vehicle updates
            socket.on('vehicle_updated', function(data) {
                if (data.vehicle_id == currentVehicleId) {
                    console.log('Vehicle updated via WebSocket:', data);
                    // Reload vehicle details
                    loadVehicleDetails();
                    // Check for trip updates
                    checkActiveTrip();
                }
            });
            
            // Listen for trip updates
            socket.on('trip_updated', function(data) {
                if (data.vehicle_id == currentVehicleId) {
                    console.log('Trip updated via WebSocket:', data);
                    checkActiveTrip();
                }
            });
            
            // Listen for passenger events
            socket.on('passenger_event', function(data) {
                if (data.vehicle_id == currentVehicleId) {
                    console.log('Passenger event via WebSocket:', data);
                    checkActiveTrip();
                }
            });
        } else {
            console.log('Socket.IO not available, using polling for updates');
            // Fallback to polling every 30 seconds
            setInterval(() => {
                loadVehicleDetails();
                checkActiveTrip();
            }, 30000);
        }
    }
    
    function setupEventListeners() {
        // Occupancy buttons
        document.getElementById('setVacant').addEventListener('click', () => {
            showConfirmation(
                'Set Vehicle as Vacant?', 
                'Are you sure you want to mark this vehicle as vacant?',
                () => updateOccupancyStatus('vacant')
            );
        });
        
        document.getElementById('setFull').addEventListener('click', () => {
            showConfirmation(
                'Set Vehicle as Full?', 
                'Are you sure you want to mark this vehicle as full?',
                () => updateOccupancyStatus('full')
            );
        });
        
        // Route buttons
        document.getElementById('startRoute').addEventListener('click', () => {
            const origin = document.getElementById('originInput').value.trim();
            const destination = document.getElementById('destinationInput').value.trim();
            
            if (!origin || !destination) {
                alert('Please enter both origin and destination');
                return;
            }
            
            showConfirmation(
                'Start Route?', 
                `Are you sure you want to start a route from "${origin}" to "${destination}"?`,
                () => startRoute(origin, destination)
            );
        });
        
        document.getElementById('abortRoute').addEventListener('click', () => {
            showConfirmation(
                'Abort Route?', 
                'Are you sure you want to abort the current route?',
                abortRoute
            );
        });
        
        // Trip buttons
        document.getElementById('startTrip').addEventListener('click', () => {
            showConfirmation(
                'Start Trip?', 
                'Are you sure you want to start a new trip?',
                startTrip
            );
        });
        
        document.getElementById('endTrip').addEventListener('click', () => {
            showConfirmation(
                'End Trip?', 
                'Are you sure you want to end the current trip?',
                endTrip
            );
        });
        
        // Passenger buttons
        document.getElementById('passengerBoard').addEventListener('click', () => {
            pendingEventType = 'board';
            showPassengerCountModal('Passenger Boarding');
        });
        
        document.getElementById('passengerAlight').addEventListener('click', () => {
            pendingEventType = 'alight';
            showPassengerCountModal('Passenger Alighting');
        });
        
        // Confirm passenger count
        document.getElementById('confirmPassengerCount').addEventListener('click', () => {
            const count = parseInt(document.getElementById('passengerCountInput').value);
            const notes = document.getElementById('passengerNotes').value.trim();
            
            if (isNaN(count) || count < 1) {
                alert('Please enter a valid passenger count');
                return;
            }
            
            recordPassengerEvent(pendingEventType, count, notes);
            $('#passengerCountModal').modal('hide');
        });
    }
    
    async function loadVehicleDetails() {
        try {
            const response = await fetch(`/api/vehicles/${currentVehicleId}`);
            const data = await response.json();
            
            if (!response.ok) {
                throw new Error(data.error || 'Failed to load vehicle details');
            }
            
            currentVehicleData = data.vehicle;
            updateVehicleUI(currentVehicleData);
        } catch (error) {
            console.error('Error loading vehicle details:', error);
            alert('Error loading vehicle details: ' + error.message);
        }
    }
    
    function updateVehicleUI(vehicle) {
        document.getElementById('vehicleRegistration').textContent = vehicle.registration_number;
        document.getElementById('vehicleType').textContent = vehicle.vehicle_type;
        document.getElementById('vehicleStatus').textContent = vehicle.status;
        document.getElementById('vehicleRoute').textContent = vehicle.route || 'None';
        document.getElementById('vehicleLastUpdated').textContent = vehicle.last_updated ? new Date(vehicle.last_updated).toLocaleString() : 'Never';
        
        // Update occupancy status
        const occupancyStatus = document.getElementById('occupancyStatus');
        occupancyStatus.textContent = vehicle.occupancy_status === 'full' ? 'Full' : 'Vacant';
        occupancyStatus.className = vehicle.occupancy_status === 'full' ? 'badge bg-danger' : 'badge bg-success';
        
        // Update button states
        document.getElementById('setVacant').disabled = vehicle.occupancy_status === 'vacant';
        document.getElementById('setFull').disabled = vehicle.occupancy_status === 'full';
    }
    
    async function checkActiveTrip() {
        try {
            const response = await fetch(`/operator/vehicle/${currentVehicleId}/trip/current`);
            const data = await response.json();
            
            if (!response.ok) {
                throw new Error(data.error || 'Failed to check active trip');
            }
            
            if (data.trip) {
                // Show active trip UI
                currentTripId = data.trip.id;
                document.getElementById('noActiveTrip').style.display = 'none';
                document.getElementById('activeTrip').style.display = 'block';
                
                // Update trip details
                document.getElementById('tripId').textContent = data.trip.id;
                document.getElementById('tripStartTime').textContent = new Date(data.trip.start_time).toLocaleString();
                
                // Update passenger count
                const passengerCount = data.trip.passenger_summary ? data.trip.passenger_summary.current_passengers : 0;
                document.getElementById('passengerCount').textContent = passengerCount;
            } else {
                // Show no active trip UI
                currentTripId = null;
                document.getElementById('noActiveTrip').style.display = 'block';
                document.getElementById('activeTrip').style.display = 'none';
            }
        } catch (error) {
            console.error('Error checking active trip:', error);
            // Default to no active trip
            currentTripId = null;
            document.getElementById('noActiveTrip').style.display = 'block';
            document.getElementById('activeTrip').style.display = 'none';
        }
    }
    
    async function updateOccupancyStatus(status) {
        try {
            const response = await fetch(`/operator/vehicle/${currentVehicleId}/occupancy`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ occupancy_status: status })
            });
            
            const data = await response.json();
            
            if (!response.ok) {
                throw new Error(data.error || 'Failed to update occupancy status');
            }
            
            // Reload vehicle details
            loadVehicleDetails();
            
            // Show success message
            alert(`Vehicle occupancy status updated to ${status}`);
        } catch (error) {
            console.error('Error updating occupancy status:', error);
            alert('Error updating occupancy status: ' + error.message);
        }
    }
    
    async function startRoute(origin, destination) {
        try {
            const routeName = `${origin} to ${destination}`;
            
            const response = await fetch(`/api/vehicles/${currentVehicleId}/route`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ route: routeName })
            });
            
            const data = await response.json();
            
            if (!response.ok) {
                throw new Error(data.error || 'Failed to start route');
            }
            
            // Enable abort button
            document.getElementById('abortRoute').disabled = false;
            
            // Reload vehicle details
            loadVehicleDetails();
            
            // Show success message
            alert(`Route started: ${routeName}`);
        } catch (error) {
            console.error('Error starting route:', error);
            alert('Error starting route: ' + error.message);
        }
    }
    
    async function abortRoute() {
        try {
            const response = await fetch(`/api/vehicles/${currentVehicleId}/route`, {
                method: 'DELETE'
            });
            
            const data = await response.json();
            
            if (!response.ok) {
                throw new Error(data.error || 'Failed to abort route');
            }
            
            // Disable abort button
            document.getElementById('abortRoute').disabled = true;
            
            // Clear route inputs
            document.getElementById('originInput').value = '';
            document.getElementById('destinationInput').value = '';
            
            // Reload vehicle details
            loadVehicleDetails();
            
            // Show success message
            alert('Route aborted successfully');
        } catch (error) {
            console.error('Error aborting route:', error);
            alert('Error aborting route: ' + error.message);
        }
    }
    
    async function startTrip() {
        try {
            const response = await fetch(`/operator/vehicle/${currentVehicleId}/trip/start`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    vehicle_id: currentVehicleId,
                    route_name: currentVehicleData.route || 'No route'
                })
            });
            
            const data = await response.json();
            
            if (!response.ok) {
                throw new Error(data.error || 'Failed to start trip');
            }
            
            // Check for active trip
            checkActiveTrip();
            
            // Show success message
            alert('Trip started successfully');
        } catch (error) {
            console.error('Error starting trip:', error);
            alert('Error starting trip: ' + error.message);
        }
    }
    
    async function endTrip() {
        try {
            const response = await fetch(`/operator/vehicle/${currentVehicleId}/trip/end`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    vehicle_id: currentVehicleId
                })
            });
            
            const data = await response.json();
            
            if (!response.ok) {
                throw new Error(data.error || 'Failed to end trip');
            }
            
            // Check for active trip
            checkActiveTrip();
            
            // Show success message
            alert('Trip ended successfully');
        } catch (error) {
            console.error('Error ending trip:', error);
            alert('Error ending trip: ' + error.message);
        }
    }
    
    async function recordPassengerEvent(eventType, count, notes) {
        try {
            const response = await fetch(`/operator/vehicle/${currentVehicleId}/passenger`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    vehicle_id: currentVehicleId,
                    event_type: eventType,
                    count: count,
                    notes: notes
                })
            });
            
            const data = await response.json();
            
            if (!response.ok) {
                throw new Error(data.error || 'Failed to record passenger event');
            }
            
            // Check for active trip to update passenger count
            checkActiveTrip();
            
            // Show success message
            alert(`Passenger ${eventType} event recorded successfully`);
        } catch (error) {
            console.error('Error recording passenger event:', error);
            alert('Error recording passenger event: ' + error.message);
        }
    }
    
    function showConfirmation(title, message, confirmCallback) {
        document.getElementById('confirmationTitle').textContent = title;
        document.getElementById('confirmationMessage').textContent = message;
        
        // Store the callback
        pendingAction = confirmCallback;
        
        // Set up confirm button
        document.getElementById('confirmButton').onclick = function() {
            if (pendingAction) {
                pendingAction();
            }
            $('#confirmationModal').modal('hide');
        };
        
        // Show the modal
        $('#confirmationModal').modal('show');
    }
    
    function showPassengerCountModal(title) {
        document.getElementById('passengerCountTitle').textContent = title;
        document.getElementById('passengerCountInput').value = '1';
        document.getElementById('passengerNotes').value = '';
        
        // Show the modal
        $('#passengerCountModal').modal('show');
    }
</script>
{% endblock %}
