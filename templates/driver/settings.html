{% extends 'base.html' %}

{% block title %}Driver Settings{% endblock %}

{% block extra_css %}
<!-- Bootstrap CSS for toasts -->
<style>
    .toast-container {
        z-index: 9999;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="row">
        <div class="col-12">
            <h1 class="mb-4">
                <i class="fas fa-cog me-2"></i>Driver Settings
            </h1>
        </div>
    </div>

    <div class="row">
        <!-- Password Change -->
        <div class="col-md-6 mb-4">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0">
                        <i class="fas fa-key me-2"></i>Change Password
                    </h5>
                </div>
                <div class="card-body">
                    <form id="passwordForm">
                        <div class="mb-3">
                            <label for="currentPassword" class="form-label">Current Password</label>
                            <input type="password" class="form-control" id="currentPassword" required>
                        </div>
                        <div class="mb-3">
                            <label for="newPassword" class="form-label">New Password</label>
                            <input type="password" class="form-control" id="newPassword" required>
                        </div>
                        <div class="mb-3">
                            <label for="confirmPassword" class="form-label">Confirm New Password</label>
                            <input type="password" class="form-control" id="confirmPassword" required>
                        </div>
                        <button type="submit" class="btn btn-warning">
                            <i class="fas fa-key me-2"></i>Change Password
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Data Export -->
        <div class="col-md-6 mb-4">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-download me-2"></i>Data Export
                    </h5>
                </div>
                <div class="card-body">
                    <p class="text-muted">Export your data for backup or analysis purposes.</p>
                    <div class="d-grid gap-2">
                        <button type="button" class="btn btn-outline-success" id="exportTripBtn">
                            <i class="fas fa-route me-2"></i>Export Trip History
                        </button>
                        <button type="button" class="btn btn-outline-success" id="exportLogsBtn">
                            <i class="fas fa-history me-2"></i>Export Action Logs
                        </button>
                        <button type="button" class="btn btn-outline-success" id="exportProfileBtn">
                            <i class="fas fa-user me-2"></i>Export Profile Data
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="container mt-3">
    <div class="row">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-body">
                    {% if logs %}
                    <h5 class="mb-3"><i class="fas fa-history me-2"></i>Recent Action Logs</h5>
                    <div class="table-responsive">
                        <table class="table table-striped table-hover mb-3">
                            <thead>
                                <tr>
                                    <th>Date & Time</th>
                                    <th>Action</th>
                                    <th>Vehicle</th>

                                </tr>
                            </thead>
                            <tbody>
                                {% for log in logs %}
                                <tr>
                                    <td>{{ log.created_at.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                                    <td>
                                        {% if log.action == 'occupancy_change' %}
                                            <span class="badge bg-info">Occupancy Change</span>
                                        {% elif log.action == 'trip_start' %}
                                            <span class="badge bg-success">Trip Start</span>
                                        {% elif log.action == 'trip_end' %}
                                            <span class="badge bg-warning">Trip End</span>
                                        {% elif log.action == 'passenger_board' %}
                                            <span class="badge bg-primary">Passenger Boarding</span>
                                        {% elif log.action == 'passenger_alight' %}
                                            <span class="badge bg-secondary">Passenger Alighting</span>
                                        {% elif log.action == 'password_change' %}
                                            <span class="badge bg-dark">Password Change</span>
                                        {% else %}
                                            <span class="badge bg-light text-dark">{{ log.action|capitalize }}</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if log.vehicle_id %}
                                            Vehicle #{{ log.vehicle_id }}
                                        {% else %}
                                            N/A
                                        {% endif %}
                                    </td>
                                    
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    <div class="text-end">
                        <a href="{{ url_for('driver.view_action_logs') }}" class="btn btn-outline-primary">
                            View All Action Logs
                        </a>
                    </div>
                    {% else %}
                    <div class="d-flex justify-content-end">
                        <a href="{{ url_for('driver.view_action_logs') }}" class="btn btn-outline-primary">
                            <i class="fas fa-history me-2"></i>Action Logs
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Confirmation Modal -->
<div class="modal fade" id="confirmationModal" tabindex="-1" aria-labelledby="confirmationModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="confirmationModalLabel">Confirm Action</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="confirmationMessage">
                Are you sure you want to proceed with this action?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirmActionBtn">Confirm</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}



{% block extra_js %}
<script src="{{ url_for('static', filename='js/driver-settings.js') }}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
  document.querySelectorAll('.view-details').forEach(function(btn) {
    btn.addEventListener('click', function() {
      const action = this.getAttribute('data-action');
      const metaData = JSON.parse(this.getAttribute('data-meta')) || {};
      const container = document.createElement('div');
      let html = '<dl class="row">';
      if (metaData.timestamp) {
        const d = new Date(metaData.timestamp);
        html += `<dt class="col-sm-4">Timestamp</dt><dd class="col-sm-8">${d.toLocaleString()}</dd>`;
      }
      if (action === 'occupancy_change') {
        html += `<dt class="col-sm-4">Old Status</dt><dd class="col-sm-8">${metaData.old_value || 'N/A'}</dd>`;
        html += `<dt class="col-sm-4">New Status</dt><dd class="col-sm-8">${metaData.new_value || 'N/A'}</dd>`;
      } else if (action === 'trip_start') {
        html += `<dt class="col-sm-4">Trip ID</dt><dd class="col-sm-8">${metaData.trip_id || 'N/A'}</dd>`;
        html += `<dt class="col-sm-4">Route</dt><dd class="col-sm-8">${metaData.route_name || 'N/A'}</dd>`;
      } else if (action === 'trip_end') {
        html += `<dt class="col-sm-4">Trip ID</dt><dd class="col-sm-8">${metaData.trip_id || 'N/A'}</dd>`;
        html += `<dt class="col-sm-4">Route</dt><dd class="col-sm-8">${metaData.route_name || 'N/A'}</dd>`;
        html += `<dt class="col-sm-4">Duration</dt><dd class="col-sm-8">${metaData.duration_minutes || 0} minutes</dd>`;
      } else if (action === 'passenger_board' || action === 'passenger_alight') {
        html += `<dt class="col-sm-4">Trip ID</dt><dd class="col-sm-8">${metaData.trip_id || 'N/A'}</dd>`;
        html += `<dt class="col-sm-4">Count</dt><dd class="col-sm-8">${metaData.count || 0} passengers</dd>`;
        if (metaData.notes) {
          html += `<dt class="col-sm-4">Notes</dt><dd class="col-sm-8">${metaData.notes}</dd>`;
        }
      }
      for (const [k, v] of Object.entries(metaData)) {
        if (!['timestamp','old_value','new_value','trip_id','route_name','duration_minutes','count','notes'].includes(k)) {
          html += `<dt class="col-sm-4">${k}</dt><dd class="col-sm-8">${v}</dd>`;
        }
      }
      html += '</dl>';
      container.innerHTML = html;

      const modalEl = document.createElement('div');
      modalEl.className = 'modal fade';
      modalEl.innerHTML = `
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">Log Details</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body"></div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
          </div>
        </div>`;
      document.body.appendChild(modalEl);
      modalEl.querySelector('.modal-body').appendChild(container);
      const modal = new bootstrap.Modal(modalEl);
      modal.show();
      modalEl.addEventListener('hidden.bs.modal', function(){ modalEl.remove(); });
    });
  });
});
</script>
{% endblock %}
